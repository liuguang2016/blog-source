---
nav:
  title: 宏任务与微任务
  order: 1
---

---

# 宏任务与微任务

![WechatIMG166](https://tva1.sinaimg.cn/large/e6c9d24ely1h09d491ae4j21410u0q7a.jpg)

## **异步的诞生背景**

首先 js 是单线程执行，在同一时刻只能做一件事，我们把 js 引擎比喻为银行的柜员，柜员一次只能给一个客户提供服务，开始银行是没有任何其它设计的，来了个客户看见柜员空闲了去马上跑上去办理业务，根本就没有啥先来后到之说，这就导致了银行内经常发生办业务的人都围在柜员前面，有时还要大打出手，行长一看这不行啊，必须要想个办法。

经过老行长的苦思冥想，终于有了，那你们就排队吧，先来的站前面，后来的站后面谁都不许乱了秩序，不然，嘿嘿请你”喝茶“。

在 js 中我们把像，进银行钱扫二维码，测体温，刷身份证取号，这种必须从上到下立即执行的，在 js 中叫**同步任务**，例如：声明语句，for 循环，赋值，实例化等

开始执行大就都说好，老行长真英明。但是没多久问题又来了，老人排队站久了导致晕倒，同时几乎所有人都抱怨，经常去银行帮个业务排队都要大半天，啥都干不了，太浪费时间了。没办法，老行长只能再想办法，经过他多方求助，招人参谋，终于银行的取号排队，叫号办理业务机制诞生了。在 js 中不是立即执行的，需要先加入任务队列等待的执行叫做**异步任务**，例如：ajax,setTimeout 等

## **宏任务的诞生**

在银行办理业务的客户，在拿到排队号码前和拿到号码后其实是两个状态，拿到号码后客户就可以暂时不用管要办理的业务，这时一般都还坐在旁边，玩玩手机，聊聊天等做些其它的，在 js 中也是一样，当异步任务加入**任务队列**（Event Queue）后我们加它**宏任任务**，例如：script(JS 整体代码)、setTimeout、setInterval、setImmediate、I/O、UI 交互

任务队列中的都是已经完成的异步操作，而不是说注册一个异步任务就会被放在这个任务队列中，就像在银行中排号，如果叫到你的时候你不在，那么你当前的号牌就作废了，柜员会选择直接跳过进行下一个客户的业务处理，等你回来以后还需要重新取号

## **微任务的诞生**

有一天，银行来了位要存款的大爷，在办理完存款业务后，存完款后柜员问，”您还有别的业务需要办理吗？“，大爷一想，这几大万就这么存不划算，要不搞个稳定点的理财，于是给柜员说了，这时肯定不能让大爷再去排队区号了啊，比较”你大爷永远是你大爷“，本来快轮到后面兄弟办理业务的，因为大爷新的”理财业务“，就只能继续等了。

在 js 中我们把这种”理财业务“叫做**微任务**，常见的微任务有 Promise(重点关注)、process.nextTick(Node.js)、MutaionObserver 等。

## 使用场景

```javascript
setTimeout((_) => console.log(4));

new Promise((resolve) => {
  resolve();
  console.log(1);
}).then((_) => {
  console.log(3);
});

console.log(2);
```

首先来说运行结果：

1、2、3、4

任务拆解：

- 整个 script 块代码是个宏任务 A
- setTimeout 是个宏任务 B
- Promise.then()微任务 a
- new Promise 是 A 的同步任务 1
- console.log(2)是 A 的同步任务 2

整个的任务队列抽象如下：

```yaml
[A:[1,2,a],B]
```

代码整体从上到下，解析执行故 **A**先入任务队列，接着**B**再入任务队列

1. A 先入任务队列，也就会先出，先执行。执行 A 时，同步任务从上到下执行。也就有了打印 1，2；
2. a 是 A 的微任务，就如同上面大爷的”理财业务“它也会在 A 的其它任务结束后紧接着执行，故打印 3；
3. 宏任务 A 都执行完了，现在轮到任务队列吐出第二个宏任务 B 了，执行 B 也就有了打印 4；
